# KerasToCpp - CPU

You may want to test a model you created using Keras in a C environment. This place was created to solve this problem. You can save the training weights of the model you created using Keras and then use it in the C environment. All layer and activation functions are designed to run using CPU. The layers created so far are as follows:

## Supported Keras layers

- ***Layers***
  - :white_check_mark: Dense
  - :white_check_mark: Conv2D
  - :white_check_mark: Flatten
  - :white_check_mark: MaxPooling2D
  - :white_check_mark: BatchNormalization

- ***Activations***
  - :white_check_mark: Sigmoid
  - :white_check_mark: ReLU

## Design goals

  - Compatibility with networks generated by Keras using TensorFlow backend.
  - CPU only.
  - No external dependencies, standard library, C++17.

## User guide

I assume you have "KernelCpu" and "CpuMat" files before using all layers. Before the model is designed, the input must be determined.
As an example, let's say an RGB image with dimensions of 512x512x3 is input.

If the first layer you will use is Dense, the bias value should be used for both the input and the first layer. Also, if 512x512x3 RGB input is converted to vector, it becomes a 1x512*512*3 vector.

```ini
input = new CpuMat(512, 512, 3, true);              // CpuMat(input.Height, input.Width, input.Depth, useBias = true)

dense = new Dense(100, 1, 512 * 512 * 3, true)      // Dense(number of neurons, input_rows, input_cols, useBias = true)
.
.
```

If your first layer is Conv2D, no bias value should be used for the input. However, the bias value should be used in the first Conv2D layer.

```ini
input = new CpuMat(512, 512, 3, false);     // CpuMat(input.Height, input.Width, input.Depth, useBias = true)

conv = new Conv2D(8, 3, 3, input, true);    // Conv2D(number of filters, filter_height, filter_width, input, useBias = true)
.
.
```

## Example conversions from Keras to CPP

Suppose we want to transform the following example Keras model.

```ini
    model = Sequential()

    model.add(layers.Conv2D(8, (3, 3), activation='relu', padding='valid', input_shape=(512,512,3)))
    model.add(layers.MaxPooling2D((2, 2)))

    model.add(layers.Conv2D(16, (3, 3), activation='relu'))
    model.add(layers.MaxPooling2D((2, 2)))     
    model.add(layers.Flatten())                             

    model.add(Dense(16, activation="relu"))
    model.add(BatchNormalization())
    model.add(Dense(1, activation="sigmoid"))             # unipolar sigmoid (0-1)
```

First, the layers must be defined. Activation functions will be implemented in the testing stage.
Since the first layer is Conv2D, bias is not use for the input. However, the bias value should be used in the first Conv2D layer.

```ini
input = new CpuMat(512, 512, 3, false);                     // CpuMat(input.Height, input.Width, input.Depth, useBias = true)

conv = new Conv2D(8, 3, 3, input, true);                    // Conv2D(number of filters, filter_height, filter_width, input, useBias = true)
maxPool = new MaxPooling2D(conv->Result, 2, 2, 2, 2);       // Each layer gets the result values of the previous layer
conv1 = new Conv2D(16, 3, 3, maxPool->Result);
maxPool1 = new MaxPooling2D(conv1->Result, 2, 2, 2, 2);
flatten = new Flatten(maxPool1->Result);
dense = new Dense(16, flatten->Result->Rows, flatten->Result->Cols);
batchNorm = new BatchNormalization(dense->Result->Rows, dense->Result->Cols);
dense1 = new Dense(1, dense->Result->Rows, dense->Result->Cols, false);       // Dense(neurons, inputRows, inputCols, useBias = true)
```

Each layer gets the result values of the previous layer. No bias value is used in the last layer.

Keras weights are in hdf5 file format. It is converted to a text file for use with the C environment. Details [here](https://github.com/fbasatemur/KerasToCpp/tree/master/CPU#how-to-use-keras-model-weights-in-the-c-environment-).
Then the weights of each layers are loaded. For example, let's load the model weights from the "model_save" directory :

```ini
std::string weightFolder = "model_save\\"

std::string conv2DKernel = weightFolder + "conv2d\\kernel.txt";
std::string conv2DBias = weightFolder + "conv2d\\bias.txt";

std::string conv2D1Kernel = weightFolder + "conv2d_1\\kernel.txt";
std::string conv2D1Bias = weightFolder + "conv2d_1\\bias.txt";

std::string denseKernel = weightFolder + "dense\\kernel.txt";
std::string denseBias = weightFolder + "dense\\bias.txt";

std::string dense1Kernel = weightFolder + "dense_1\\kernel.txt";
std::string dense1Bias = weightFolder + "dense_1\\bias.txt";

std::string batchNormBeta = weightFolder + "batch_normalization\\beta.txt";
std::string batchNormGamma = weightFolder + "batch_normalization\\gamma.txt";
std::string batchNormMovingMean = weightFolder + "batch_normalization\\moving_mean.txt";
std::string batchNormMovingVariance = weightFolder + "batch_normalization\\moving_variance.txt";

// Load kernel and bias weights
conv->Load(conv2DKernel, conv2DBias);
conv1->Load(conv2D1Kernel, conv2D1Bias);

dense->Load(denseKernel, denseBias);
dense1->Load(dense1Kernel, dense1Bias);

// Load batchnormalization layer weights
batchNorm->Load(batchNormBeta, batchNormGamma, batchNormMovingMean, batchNormMovingVariance);

```

The image to be tested must be set to the input->CpuP pointer.  
Then, each layer is applied to input.

```ini
conv->Apply(input);
cpuRelu(conv->Result);            // Apply ReLU activation
maxPool->Apply(conv->Result);

conv1->Apply(maxPool->Result);
cpuRelu(conv1->Result);
maxPool1->Apply(conv1->Result);

flatten->Apply(maxPool1->Result);

dense->Apply(flatten->Result);
cpuRelu(dense->Result);
batchNorm->Apply(dense->Result);

dense1->Apply(dense->Result);
cpuSigmoid(dense1->Result);      // Apply Sigmoid (Unipolar) activation
```

Finally the predict value is read from pointer CpuP of end layer.

```ini
predict = (float*)dense1->Result->CpuP;
```

A sample project created using all layers can be accessed here: [Surface_Detection](https://github.com/fbasatemur/Surface_Detection)

## How to use Keras model weights in the C environment ?

Keras weights are in hdf5 file format. I assume you got the model record as .json and .h5.
You can create your model training weights as follows:

```ini
# keras library import  for Saving and loading model and weights

from keras.models import model_from_json
from keras.models import load_model

# serialize model to JSON
#  the keras model which is trained is defined as 'model' in this example
model_json = model.to_json()

with open("model_save_json.json", "w") as json_file:
    json_file.write(model_json)

# serialize weights to HDF5
model.save_weights("model_save_weight.h5")
```

It is converted to a text file for use with the C environment. You can do it as follows:

```ini
python h5_to_txt.py model_save_weight.h5
```

Each layer in the model will be saved in a folder and their weight in it. The text files will then be loaded into the model layers.
